#include <math.h>
#include "DDS.h"

// #define REFCLK (double)31372.549

uint16_t wavetable[] = {
2048, 2060, 2073, 2085, 2098, 2110, 2123, 2136, 2148, 2161, 2173, 2186, 2198, 2211, 2223, 2236, 2248, 2261, 2273, 2286, 2298, 2311, 2323, 2336, 2348, 2361, 2373, 2386, 2398, 2410, 2423, 2435, 2447, 2460, 2472, 2484, 2497, 2509, 2521, 2533, 2546, 2558, 2570, 2582, 2594, 2606, 2618, 2631, 2643, 2655, 2667, 2679, 2691, 2702, 2714, 2726, 2738, 2750, 2762, 2774, 2785, 2797, 2809, 2820, 2832, 2844, 2855, 2867, 2878, 2890, 2901, 2913, 2924, 2935, 2947, 2958, 2969, 2980, 2992, 3003, 3014, 3025, 3036, 3047, 3058, 3069, 3080, 3091, 3101, 3112, 3123, 3133, 3144, 3155, 3165, 3176, 3186, 3197, 3207, 3217, 3228, 3238, 3248, 3258, 3269, 3279, 3289, 3299, 3309, 3318, 3328, 3338, 3348, 3357, 3367, 3377, 3386, 3396, 3405, 3415, 3424, 3433, 3442, 3452, 3461, 3470, 3479, 3488, 3497, 3506, 3514, 3523, 3532, 3541, 3549, 3558, 3566, 3575, 3583, 3591, 3599, 3608, 3616, 3624, 3632, 3640, 3648, 3655, 3663, 3671, 3678, 3686, 3694, 3701, 3708, 3716, 3723, 3730, 3737, 3744, 3751, 3758, 3765, 3772, 3779, 3786, 3792, 3799, 3805, 3812, 3818, 3824, 3830, 3837, 3843, 3849, 3855, 3861, 3866, 3872, 3878, 3883, 3889, 3894, 3900, 3905, 3910, 3916, 3921, 3926, 3931, 3936, 3941, 3945, 3950, 3955, 3959, 3964, 3968, 3972, 3977, 3981, 3985, 3989, 3993, 3997, 4001, 4004, 4008, 4012, 4015, 4019, 4022, 4025, 4029, 4032, 4035, 4038, 4041, 4044, 4046, 4049, 4052, 4054, 4057, 4059, 4061, 4064, 4066, 4068, 4070, 4072, 4074, 4076, 4077, 4079, 4080, 4082, 4083, 4085, 4086, 4087, 4088, 4089, 4090, 4091, 4092, 4093, 4093, 4094, 4094, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4094, 4094, 4093, 4093, 4092, 4091, 4091, 4090, 4089, 4088, 4087, 4085, 4084, 4083, 4081, 4080, 4078, 4076, 4075, 4073, 4071, 4069, 4067, 4065, 4063, 4060, 4058, 4055, 4053, 4050, 4048, 4045, 4042, 4039, 4036, 4033, 4030, 4027, 4024, 4020, 4017, 4013, 4010, 4006, 4003, 3999, 3995, 3991, 3987, 3983, 3979, 3974, 3970, 3966, 3961, 3957, 3952, 3948, 3943, 3938, 3933, 3928, 3923, 3918, 3913, 3908, 3903, 3897, 3892, 3886, 3881, 3875, 3869, 3863, 3858, 3852, 3846, 3840, 3834, 3827, 3821, 3815, 3808, 3802, 3795, 3789, 3782, 3775, 3769, 3762, 3755, 3748, 3741, 3734, 3727, 3719, 3712, 3705, 3697, 3690, 3682, 3675, 3667, 3659, 3651, 3644, 3636, 3628, 3620, 3612, 3603, 3595, 3587, 3579, 3570, 3562, 3553, 3545, 3536, 3528, 3519, 3510, 3501, 3492, 3483, 3474, 3465, 3456, 3447, 3438, 3429, 3419, 3410, 3400, 3391, 3382, 3372, 3362, 3353, 3343, 3333, 3323, 3313, 3304, 3294, 3284, 3274, 3263, 3253, 3243, 3233, 3223, 3212, 3202, 3192, 3181, 3171, 3160, 3149, 3139, 3128, 3117, 3107, 3096, 3085, 3074, 3063, 3052, 3041, 3030, 3019, 3008, 2997, 2986, 2975, 2964, 2952, 2941, 2930, 2918, 2907, 2895, 2884, 2872, 2861, 2849, 2838, 2826, 2814, 2803, 2791, 2779, 2768, 2756, 2744, 2732, 2720, 2708, 2696, 2685, 2673, 2661, 2649, 2637, 2624, 2612, 2600, 2588, 2576, 2564, 2552, 2539, 2527, 2515, 2503, 2491, 2478, 2466, 2454, 2441, 2429, 2417, 2404, 2392, 2379, 2367, 2355, 2342, 2330, 2317, 2305, 2292, 2280, 2267, 2255, 2242, 2230, 2217, 2205, 2192, 2179, 2167, 2154, 2142, 2129, 2117, 2104, 2092, 2079, 2066, 2054, 2041, 2029, 2016, 2003, 1991, 1978, 1966, 1953, 1941, 1928, 1916, 1903, 1890, 1878, 1865, 1853, 1840, 1828, 1815, 1803, 1790, 1778, 1765, 1753, 1740, 1728, 1716, 1703, 1691, 1678, 1666, 1654, 1641, 1629, 1617, 1604, 1592, 1580, 1568, 1556, 1543, 1531, 1519, 1507, 1495, 1483, 1471, 1458, 1446, 1434, 1422, 1410, 1399, 1387, 1375, 1363, 1351, 1339, 1327, 1316, 1304, 1292, 1281, 1269, 1257, 1246, 1234, 1223, 1211, 1200, 1188, 1177, 1165, 1154, 1143, 1131, 1120, 1109, 1098, 1087, 1076, 1065, 1054, 1043, 1032, 1021, 1010, 999, 988, 978, 967, 956, 946, 935, 924, 914, 903, 893, 883, 872, 862, 852, 842, 832, 821, 811, 801, 791, 782, 772, 762, 752, 742, 733, 723, 713, 704, 695, 685, 676, 666, 657, 648, 639, 630, 621, 612, 603, 594, 585, 576, 567, 559, 550, 542, 533, 525, 516, 508, 500, 492, 483, 475, 467, 459, 451, 444, 436, 428, 420, 413, 405, 398, 390, 383, 376, 368, 361, 354, 347, 340, 333, 326, 320, 313, 306, 300, 293, 287, 280, 274, 268, 261, 255, 249, 243, 237, 232, 226, 220, 214, 209, 203, 198, 192, 187, 182, 177, 172, 167, 162, 157, 152, 147, 143, 138, 134, 129, 125, 121, 116, 112, 108, 104, 100, 96, 92, 89, 85, 82, 78, 75, 71, 68, 65, 62, 59, 56, 53, 50, 47, 45, 42, 40, 37, 35, 32, 30, 28, 26, 24, 22, 20, 19, 17, 15, 14, 12, 11, 10, 8, 7, 6, 5, 4, 4, 3, 2, 2, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 2, 2, 3, 4, 5, 6, 7, 8, 9, 10, 12, 13, 15, 16, 18, 19, 21, 23, 25, 27, 29, 31, 34, 36, 38, 41, 43, 46, 49, 51, 54, 57, 60, 63, 66, 70, 73, 76, 80, 83, 87, 91, 94, 98, 102, 106, 110, 114, 118, 123, 127, 131, 136, 140, 145, 150, 154, 159, 164, 169, 174, 179, 185, 190, 195, 201, 206, 212, 217, 223, 229, 234, 240, 246, 252, 258, 265, 271, 277, 283, 290, 296, 303, 309, 316, 323, 330, 337, 344, 351, 358, 365, 372, 379, 387, 394, 401, 409, 417, 424, 432, 440, 447, 455, 463, 471, 479, 487, 496, 504, 512, 520, 529, 537, 546, 554, 563, 572, 581, 589, 598, 607, 616, 625, 634, 643, 653, 662, 671, 680, 690, 699, 709, 718, 728, 738, 747, 757, 767, 777, 786, 796, 806, 816, 826, 837, 847, 857, 867, 878, 888, 898, 909, 919, 930, 940, 951, 962, 972, 983, 994, 1004, 1015, 1026, 1037, 1048, 1059, 1070, 1081, 1092, 1103, 1115, 1126, 1137, 1148, 1160, 1171, 1182, 1194, 1205, 1217, 1228, 1240, 1251, 1263, 1275, 1286, 1298, 1310, 1321, 1333, 1345, 1357, 1369, 1381, 1393, 1404, 1416, 1428, 1440, 1452, 1464, 1477, 1489, 1501, 1513, 1525, 1537, 1549, 1562, 1574, 1586, 1598, 1611, 1623, 1635, 1648, 1660, 1672, 1685, 1697, 1709, 1722, 1734, 1747, 1759, 1772, 1784, 1797, 1809, 1822, 1834, 1847, 1859, 1872, 1884, 1897, 1909, 1922, 1934, 1947, 1959, 1972, 1985, 1997, 2010, 2022, 2035, 2047
  };

void DDS::init(){
  setPeriod(0);
  // setFrequency(1000.0);
}

// void DDS::setFrequency(double freq){
//   tuning = (uint32_t)(pow(2, 32)*freq/REFCLK); // calulate DDS new tuning word
// //   tword_m = (unsigned long)(pow(2,32)*freq/REFCLK); // calulate DDS new tuning word
// }

uint16_t DDS::getValue(){
  accumulator += tuning; // soft DDS, phase accu with 64 bits
  uint16_t icnt = accumulator >> 54;     // use upper bits of phase accumulator
//   uint8_t icnt = accumulator >> 8;     // use upper 8 bits for phase accu as frequency
  // read value from wave table
  return wavetable[icnt];
}
